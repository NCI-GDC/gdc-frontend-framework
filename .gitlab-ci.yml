# yaml-language-server: $schema=https://gitlab.com/gitlab-org/gitlab/-/raw/master/app/assets/javascripts/editor/schema/ci.json
---
include:
  - project: nci-gdc/gitlab-templates
    ref: master
    file:
      - templates/global/full.yaml

stages:
  - .pre
  - test
  - build
  - push

.debug-info:
  script:
    - 'echo User: "$(whoami)"'
    - 'echo Current directory: "$(pwd)"'
    - echo 'Contents of current directory:'
    - ls -lsha
    - echo 'Contents of possible directories present:'
    - ls -lsha ./* || exit 0
    - set -x

image: docker.osdc.io/node:16
variables:
  npm_config_registry: https://nexus.osdc.io/repository/npm-all/
  npm_config_cache: .npm

Install npm:
  stage: .pre
  script:
    - npm install npm@7
    - npm ci --cache .npm
  variables:
    npm_config_proxy: http://cloud-proxy:3128
    npm_config_https_proxy: http://cloud-proxy:3128
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - node_modules/
      - .npm/
    policy: push

Type Check for core:
  stage: test
  script:
    - !reference [.debug-info, script]
    - cd packages/core
    - npm run build:clean
  cache:
    key: $CI_COMMIT_REF_SLUG
    policy: pull

Type Check for portal-proto:
  stage: test
  script:
    - cd packages/portal-proto
    - npm run compile
  cache:
    key: $CI_COMMIT_REF_SLUG
    policy: pull

Linting:
  stage: test
  script:
    - !reference [.debug-info, script]
    - npm run lint
  cache:
    key: $CI_COMMIT_REF_SLUG
    policy: pull

Prettier Checks:
  stage: test
  script:
    - !reference [.debug-info, script]
    - npm run format:check
  cache:
    key: $CI_COMMIT_REF_SLUG
    policy: pull

Run unit tests:
  stage: test
  script:
    - npm run test:all
  cache:
    key: $CI_COMMIT_REF_SLUG
    policy: pull

Build and push container:
  stage: build
  services:
    - docker:${DOCKER_VERSION}-dind
  tags:
    - dind
  image: docker:${DOCKER_VERSION}-dind
  script:
    - apk add bash
    - export CLEAN_BRANCH_NAME=${CI_COMMIT_BRANCH/\//_}
    - export LOWERCASE_BRANCH_NAME="$(bash -c 'tr "[:upper:]" "[:lower:]" <<< "$CLEAN_BRANCH_NAME"')"
    - docker build --build-arg "NPM_REGISTRY=https://nexus.osdc.io/repository/npm-all/" -t $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$LOWERCASE_BRANCH_NAME-${CI_COMMIT_SHORT_SHA} .
    - docker push $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$LOWERCASE_BRANCH_NAME-${CI_COMMIT_SHORT_SHA}

Push latest container:
  variables:
    GIT_STRATEGY: none
  stage: push
  services:
    - docker:${DOCKER_VERSION}-dind
  tags:
    - dind
  image: docker:${DOCKER_VERSION}-dind
  only:
    - master
  script:
    - apk add bash
    - export CLEAN_BRANCH_NAME=${CI_COMMIT_BRANCH/\//_}
    - export LOWERCASE_BRANCH_NAME="$(bash -c 'tr "[:upper:]" "[:lower:]" <<< "$CLEAN_BRANCH_NAME"')"
    - docker pull $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$LOWERCASE_BRANCH_NAME-${CI_COMMIT_SHORT_SHA}
    - docker tag $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$LOWERCASE_BRANCH_NAME-${CI_COMMIT_SHORT_SHA} $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:latest
    - docker push $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:latest

Push tagged container:
  variables:
    GIT_STRATEGY: none
  stage: push
  services:
    - docker:${DOCKER_VERSION}-dind
  tags:
    - dind
  image: docker:${DOCKER_VERSION}-dind
  only:
    - tags
  script:
    - apk add bash
    - export CLEAN_BRANCH_NAME=${CI_COMMIT_BRANCH/\//_}
    - export LOWERCASE_BRANCH_NAME="$(bash -c 'tr "[:upper:]" "[:lower:]" <<< "$CLEAN_BRANCH_NAME"')"
    - docker pull $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$LOWERCASE_BRANCH_NAME-${CI_COMMIT_SHORT_SHA}
    - docker tag $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$LOWERCASE_BRANCH_NAME-${CI_COMMIT_SHORT_SHA} $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:${CI_COMMIT_TAG}
    - docker push $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:${CI_COMMIT_TAG}
