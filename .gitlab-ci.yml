# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html

include:
  - project: nci-gdc/gitlab-templates
    ref: master
    file:
      - templates/global/full.yaml

image: docker.osdc.io/node:16
variables:
  npm_config_registry: https://nexus.osdc.io/repository/npm-all/

Install npm:
  stage: .pre
  script:
    - npm install npm@7
    - npm install

  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
    policy: push

Type Check for core:
  stage: test
  script:
    - cd packages/core
    - npm run build:clean

  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework

Type Check for portal-proto:
  stage: test
  needs: [Type Check for core]

  script:
    - cd packages/portal-proto
    - npm run compile
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework

Linting:
  stage: test
  needs: [Type Check for portal-proto]
  script:
    - npm run lint
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework

Prettier Checks:
  stage: test
  needs: [Linting]
  script:
    - npm run format:check
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework

Run all tests:
  stage: test
  needs: [Prettier Checks]
  script:
    - npm run test:all
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
  allow_failure: true

build:
  stage: build
  services:
    - docker:20.10.16-dind
  tags:
    - gdc
  image: docker:20.10.16-dind
  before_script:
    - docker info
    - apk add --no-cache bash moreutils git go curl
    - curl -L -o dive.tar.gz https://github.com/wagoodman/dive/releases/download/v0.10.0/dive_0.10.0_linux_amd64.tar.gz
    - curl -L -o ds.tar.gz https://nexus.osdc.io/repository/misc/dockerslim/releases/1.37.5/dist_linux.tar.gz
    - tar -xvf ds.tar.gz
    - tar -xvf dive.tar.gz
    - mv dist_linux/docker-slim /usr/local/bin/
    - mv dist_linux/docker-slim-sensor /usr/local/bin/
    - rm -rf dist_linux/
    - mv dive /usr/local/bin/
    - GIT_TAG=$(git branch | sed -n -e 's/^\* \(.*\)/\1/p')
    - REPO=$(basename `git rev-parse --show-toplevel`)
    - echo $REPO
    - echo $GIT_TAG
    - echo $CI_REGISTRY_USER
    - echo $CI_REGISTRY_PASSWORD
    #    - echo $CI_COMMIT_BRANCH
    #    - echo $CI_COMMIT_SHORT_SHA
    #    - docker login docker.osdc.io -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - docker info
  #    - docker build --ssh default -t ${REGISTRY}/${REPO}:0.1 .
  #    - docker push ${REGISTRY}/${REPO}:0.1
  script:
    - echo $CI_COMMIT_BRANCH
    - echo $CI_COMMIT_SHORT_SHA
    - /bin/bash build.sh -b "$CI_COMMIT_BRANCH" -n "$CI_COMMIT_SHORT_SHA"
    - export http_proxy=http://cloud-proxy:3128
    - export https_proxy=http://cloud-proxy:3128
    - GIT_TAG=$(git branch | sed -n -e 's/^\* \(.*\)/\1/p')
    - REPO=$(basename `git rev-parse --show-toplevel`)
    - echo $REPO
    - echo $GIT_TAG
    - docker build --ssh default -t ${REGISTRY}/ncigdc/front-end/${REPO}:0.1 .
    - docker push ${REGISTRY}/ncigdc/front-end/${REPO}:0.1
