# yaml-language-server: $schema=https://gitlab.com/gitlab-org/gitlab/-/raw/master/app/assets/javascripts/editor/schema/ci.json
---
include:
  - project: nci-gdc/gitlab-templates
    ref: master
    file:
      - templates/global/full.yaml
      - templates/deployments/salt-service.yaml

.services:
  allow_failure: true
  stage: deploy
  when: manual
  parallel:
    matrix:
      - DEPLOY_SERVICE_LIST: [ portal2 ]

stages:
  - .pre
  - test
  - build
  - unit
  - release
  - deploy
  - run_ui_tests

image: docker.osdc.io/node:16-alpine3.15

variables:
  npm_config_registry: https://nexus.osdc.io/repository/npm-all/
  npm_config_cache: .npm
  DEPLOY_SERVICE_TAG: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}

workflow:
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        DEPLOY_SERVICE_TAG: ${CI_COMMIT_BRANCH}-${CI_COMMIT_TAG}
    - when: always

Install npm packages:
  stage: .pre
  script:
    - npm install npm@7
    - npm ci --cache .npm
  variables:
    npm_config_proxy: http://cloud-proxy:3128
    npm_config_https_proxy: http://cloud-proxy:3128
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - node_modules/
      - .npm/
    policy: push


Linting:
  stage: test
  before_script:
    - eslint -v || npm ci
  script:
    - npm run lint
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - node_modules/
      - .npm/
    policy: pull

Prettier Checks:
  stage: test
  before_script:
    - prettier -v || npm ci
  script:
    - npm run format:check
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - node_modules/
      - .npm/
    policy: pull

Build core and compile portal:
  stage: build
  before_script:
    - lerna -v || npm ci
  script:
    - cd ${CI_PROJECT_DIR}/packages/core
    - npm run build:clean
    - cd ${CI_PROJECT_DIR}/packages/sapien
    - npm run build:clean
    - cd ${CI_PROJECT_DIR}/packages/portal-proto
    - npm run compile
  cache:
    - key: $CI_COMMIT_REF_SLUG
      paths:
        - node_modules/
        - .npm/
      policy: pull
    - key: "Built-$CI_COMMIT_REF_SLUG"
      untracked: true
      paths:
        - node_modules/
        - .npm/
        - packages/
        - dist/
      policy: push

Run unit tests:
  stage: unit
  needs:
    - Build core and compile portal
  before_script:
    - jest -v || npm ci
  script:
    - npm run test:all
  retry: 2
  cache:
    - key: "Built-$CI_COMMIT_REF_SLUG"
      paths:
        - node_modules/
        - .npm/
        - packages/
        - dist/
      policy: pull

Build and push container:
  stage: release
  services:
    - docker:${DOCKER_VERSION}-dind
  tags:
    - dind
  image: docker:${DOCKER_VERSION}-dind
  before_script:
    - apk add bash
  script:
    - docker build --build-arg "NPM_REGISTRY=https://nexus.osdc.io/repository/npm-all/" --build-arg "BUILD_SHORT_SHA=$CI_COMMIT_SHORT_SHA" -t $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA} .
    - docker push $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA}

Push latest container:
  stage: release
  variables:
    GIT_STRATEGY: none
  services:
    - docker:${DOCKER_VERSION}-dind
  tags:
    - dind
  image: docker:${DOCKER_VERSION}-dind
  only:
    - master
  before_script:
    - apk add bash
  script:
    - docker pull $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA}
    - docker tag $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA} $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:latest
    - docker push $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:latest

Push tagged container:
  stage: release
  variables:
    GIT_STRATEGY: none
  services:
    - docker:${DOCKER_VERSION}-dind
  tags:
    - dind
  image: docker:${DOCKER_VERSION}-dind
  only:
    - tags
  before_script:
    - apk add bash
  script:
    - docker pull $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA}
    - docker tag $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA} $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:${CI_COMMIT_TAG}
    - docker push $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME:${CI_COMMIT_TAG}

Build UI tests Docker image:
  stage: release
  services:
    - docker:${DOCKER_VERSION}-dind
  tags:
    - dind
  image: docker:${DOCKER_VERSION}-dind
  script:
    - docker build -t $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME-holmes-py:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA} -f ./holmes-py/Dockerfile ./holmes-py
    - docker push $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME-holmes-py:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA}

.run_ui_tests:
  stage: run_ui_tests
  variables:
    browser: "headless chrome"
  services:
    - docker:${DOCKER_VERSION}-dind
  tags:
    - dind
  image: docker:${DOCKER_VERSION}-dind
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "pipeline"'
      when: on_success
  script:
    - docker pull $DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME-holmes-py:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA}
    - docker run -v $(pwd):/app --name holmes-py --env APP_ENVIRONMENT="$APP_ENVIRONMENT" --env browser="$BROWSER" -e PATH="$PATH:/usr/local/bin" "$DOCKER_RELEASE_REGISTRY/ncigdc/$CI_PROJECT_NAME-holmes-py:$CI_COMMIT_REF_SLUG-${CI_COMMIT_SHORT_SHA}" gauge run ./holmes-py/specs/gdc_data_portal_v2/
    - REPORT_DIR="reports_${APP_ENVIRONMENT}_${BROWSER// /_}"
    - mkdir -p $REPORT_DIR
    - docker cp holmes-py:/app/holmes-py/.gauge $REPORT_DIR/.gauge
    - docker cp holmes-py:/app/holmes-py/downloads $REPORT_DIR/downloads
    - docker cp holmes-py:/app/holmes-py/logs $REPORT_DIR/logs
    - docker cp holmes-py:/app/holmes-py/reports $REPORT_DIR/reports
  artifacts:
    when: always
    paths:
      - holmes-py/.gauge
      - holmes-py/downloads
      - holmes-py/logs
      - holmes-py/reports*
    expire_in: 3 months

Run UI tests QA Yellow:
  extends: .run_ui_tests
  stage: run_ui_tests
  variables:
    APP_ENVIRONMENT: "QA_YELLOW"
  parallel:
    matrix:
      - browser: ["headless chrome", "headless firefox", "headless safari"]
  rules:
    - if: '$DEPLOY_JOB_NAME == "deploy_qa/yellow"'
      when: on_success
      allow_failure: true

Run UI tests QA UAT:
  extends: .run_ui_tests
  stage: run_ui_tests
  variables:
    APP_ENVIRONMENT: "QA_UAT"
  parallel:
    matrix:
      - browser: [ "headless chrome", "headless firefox", "headless safari" ]
  rules:
    - if: '$DEPLOY_JOB_NAME == "deploy_qa/uat"'
      when: on_success
      allow_failure: true
