stages:
  - .pre
  - test
  - build
  - push

include:
  - project: nci-gdc/gitlab-templates
    ref: master
    file:
      - templates/global/full.yaml

image: docker.osdc.io/node:16
variables:
  npm_config_registry: https://nexus.osdc.io/repository/npm-all/

Install npm:
  stage: .pre
  script:
    - npm install npm@7
    - npm install

  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
    policy: push

Type Check for core:
  stage: test
  script:
    - cd packages/core
    - npm run build:clean

  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
  allow_failure: true

Type Check for portal-proto:
  stage: test
  needs: [Type Check for core]
  script:
    - cd packages/portal-proto
    - npm run compile
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
  allow_failure: true

Linting:
  stage: test
  script:
    - npm run lint
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework

Prettier Checks:
  stage: test
  script:
    - npm run format:check
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
  allow_failure: true

Run all tests:
  stage: test
  needs: [Type Check for portal-proto]
  script:
    - npm run test:all
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
  allow_failure: true

build docker:
  stage: build
  services:
    - docker:20.10.16-dind
  tags:
    - dind
  image: docker:20.10.16-dind
  script:
    - BRANCH="${CI_COMMIT_BRANCH//[\/]/_}"
    - export http_proxy=http://cloud-proxy:3128
    - export https_proxy=http://cloud-proxy:3128
    - docker build -t $REGISTRY/$CI_PROJECT_NAME:$BRANCH .
    - docker push $REGISTRY/$CI_PROJECT_NAME:$BRANCH

Push latest:
  variables:
    GIT_STRATEGY: none
  stage: push
  services:
    - docker:20.10.16-dind
  tags:
    - dind
  image: docker:20.10.16-dind
  only:
    - master
  script:
    - BRANCH="${CI_COMMIT_BRANCH//[\/]/_}"
    - docker pull $REGISTRY/$CI_PROJECT_NAME:$BRANCH
    - docker tag $REGISTRY/$CI_PROJECT_NAME:$BRANCH $REGISTRY/$CI_PROJECT_NAME:latest
    - docker push $REGISTRY/$CI_PROJECT_NAME:latest
