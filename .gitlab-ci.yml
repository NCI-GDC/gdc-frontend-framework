# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
include:
  - project: nci-gdc/gitlab-templates
    ref: master
    file:
      - templates/global/full.yaml

image: docker.osdc.io/node:16
variables:
  npm_config_registry: https://nexus.osdc.io/repository/npm-all/

Install npm:
  stage: .pre
  script:
    - echo "current Working directory"
    - pwd
    - echo "Files List"
    - ls
    - echo "Installing Packages"
    - npm install npm@7
    - npm install
    - echo "Installation Complete"
    - ls
    - echo ".pre stage completed"
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
    policy: push

Type Check for core:
  stage: test
  script:
    - echo "Type check for core Started"
    - echo "Current Working Directory"
    - pwd
    - echo "List of files"
    - ls
    - cd packages/core
    - echo "List of files in packages/core"
    - ls
    - echo "RUN npm build/n"
    - npm run build:clean
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework

Type Check for portal-proto:
  stage: build
  script:
    - cd packages/portal-proto
    - npm run compile
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework

Linting:
  stage: test
  script:
    - npm run lint
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
    policy: pull

Run all tests:
  stage: test
  script:
    - npm run test:all
  cache:
    key: build-cache
    paths:
      - ../gdc-frontend-framework
    policy: pull
  allow_failure: true

Build docker container:
  stage: build
  image: docker:stable
  needs: [Type Check for portal-proto]
  services:
    - name: docker:dind
      alias: thedockerhost
  variables:
    # Tell docker CLI how to talk to Docker daemon; see
    # https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-executor
    DOCKER_HOST: tcp://thedockerhost:2375/
    # Use the overlayfs driver for improved performance:
    #   DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - docker build -t $CI_REGISTRY_IMAGE .
